{% extends "layout.html" %}
{% block title %}连接配置 · {{ project.name }}{% endblock %}
{% block content %}
<h2>连接配置 · 项目：{{ project.name }}</h2>

<!-- 常量 URL 与 PID -->
<script>
  const PID = Number('{{ project.id }}');
  const URL_SEARCH = "{{ url_for('connect_bp.api_search_devices', pid=project.id) }}";
  const URL_CAND   = "{{ url_for('connect_bp.api_candidates',    pid=project.id) }}";
  const URL_MAKE   = "{{ url_for('connect_bp.api_make_link',     pid=project.id) }}";
  const URL_PORTS  = (id) => "{{ url_for('connect_bp.api_device_ports', pid=project.id, did=0) }}".replace('/0/','/'+id+'/');
  const URL_DEL    = (id) => "{{ url_for('connect_bp.api_delete_link', pid=project.id, link_id=0) }}".replace('/0/','/'+id+'/');
</script>

<section>
  <h3>设备 A</h3>
  <input id="qA" type="text" placeholder="按设备编号/型号搜索">
  <button class="btn" id="btnSearchA">搜索</button>
  <ul id="listA" class="tree"></ul>
</section>

<h3 style="margin-top:16px;">端口</h3>
<div id="ports"></div>

<script>
(() => {
  let selA = null; // 当前选择的设备A

  async function j(url){ const r = await fetch(url, {credentials:'same-origin'}); return await r.json(); }
  async function jp(url, data){
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams(data),
      credentials:'same-origin'
    });
    return await r.json();
  }
  const debounce = (fn, wait=200) => { let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; };

  // 搜索设备A
  async function searchDev(){
    try{
      const q = document.getElementById('qA').value || '';
      const res = await j(`${URL_SEARCH}?q=${encodeURIComponent(q)}`);
      const ul = document.getElementById('listA');
      ul.innerHTML='';
      (res.data||[]).forEach(d=>{
        const li=document.createElement('li');
        li.innerHTML=`<label><input type="radio" name="devA" value="${d.id}">${d.name} <span class="muted">(${d.model_code||''})</span></label>`;
        ul.appendChild(li);
      });
      ul.onchange = async ()=>{
        const v = ul.querySelector('input[name="devA"]:checked')?.value;
        selA = v?Number(v):null;
        await loadPorts();
      };
    }catch(e){ alert('搜索失败：'+e); }
  }

  // 加载设备A端口及连接
  async function loadPorts(){
    const wrap = document.getElementById('ports');
    wrap.innerHTML='';
    if(!selA) return;
    const r = await j(URL_PORTS(selA));
    if(!r.ok){ alert(r.err||'加载端口失败'); return; }
    renderPorts(r.data||[]);
  }

  function renderPorts(rows){
    const wrap = document.getElementById('ports'); wrap.innerHTML='';
    const grp={};
    rows.forEach(p=>{
      const t=p.port_type_name||'未分类';
      const a=p.attr_name||'（未命名属性）';
      (grp[t]=grp[t]||{}); (grp[t][a]=grp[t][a]||[]).push(p);
    });
    Object.keys(grp).forEach(t=>{
      const detT=document.createElement('details'); detT.open=true;
      detT.innerHTML=`<summary>${t}</summary>`;
      Object.keys(grp[t]).forEach(a=>{
        const detA=document.createElement('details'); detA.open=true;
        detA.innerHTML=`<summary>${a}</summary>`;
        const ul=document.createElement('ul');
        grp[t][a].forEach(p=>{
          const li=document.createElement('li');
          li.innerHTML=`<code>${p.name}</code>`;
          const span=document.createElement('span'); span.style.marginLeft='8px';
          if(p.link_id){
            span.innerHTML=`<code>${p.target_device_name}</code>/<code>${p.target_port_name}</code> <button class="btn danger" data-link-id="${p.link_id}">断开</button>`;
          }else{
            span.innerHTML=`<input type="text" class="searchTarget" data-port-id="${p.port_id}" placeholder="设备编号" list="dl-${p.port_id}" style="width:150px;"> <datalist id="dl-${p.port_id}"></datalist>`;
          }
          li.appendChild(span);
          ul.appendChild(li);
        });
        detA.appendChild(ul);
        detT.appendChild(detA);
      });
      wrap.appendChild(detT);
    });
  }

  // 搜索目标设备
  async function doSearchTarget(inp){
    const portId = Number(inp.dataset.portId);
    const q = inp.value || '';
    const dl = document.getElementById('dl-'+portId);
    const res = await j(`${URL_SEARCH}?q=${encodeURIComponent(q)}`);
    dl.innerHTML='';
    (res.data||[]).forEach(d=>{
      const opt=document.createElement('option');
      opt.value=`${d.id}|${d.name}`;
      opt.textContent=`${d.name} (${d.model_code||''})`;
      dl.appendChild(opt);
    });
  }
  const searchTargetDebounced = debounce(doSearchTarget,200);

  async function chooseTarget(inp){
    const portId = Number(inp.dataset.portId);
    const val = inp.value;
    const tgtId = parseInt(val.split('|')[0]);
    if(!tgtId) return;
    const r = await j(`${URL_CAND}?a=${selA}&b=${tgtId}`);
    if(!r.ok){ alert(r.err||'加载端口失败'); return; }
    const left = r.data.left||[], right = r.data.right||[];
    const me = left.find(p=>p.port_id==portId);
    if(!me){ alert('该端口无法与目标设备连接'); return; }
    const matches = right.filter(p=>p.port_type_id==me.port_type_id && (p.attr_name||'')==(me.attr_name||'') && !p.occupied);
    if(!matches.length){ alert('目标设备无可用端口'); return; }
    const sel=document.createElement('select');
    sel.innerHTML='<option value="">(选择端口)</option>'+matches.map(p=>`<option value="${p.port_id}">${p.name}</option>`).join('');
    sel.onchange = async ()=>{
      const bpid = Number(sel.value);
      if(!bpid) return;
      const rr = await jp(URL_MAKE, {a_port_id: portId, b_port_id: bpid});
      if(!rr.ok){ alert(rr.err||'连接失败'); return; }
      await loadPorts();
    };
    inp.replaceWith(sel);
  }

  async function disconnect(ev){
    const btn = ev.target.closest('button[data-link-id]');
    if(!btn) return;
    if(!confirm('确认断开该连接？')) return;
    const r = await jp(URL_DEL(btn.dataset.linkId), {});
    if(!r.ok){ alert(r.err||'断开失败'); return; }
    await loadPorts();
  }

  document.getElementById('btnSearchA').onclick = searchDev;
  document.getElementById('qA').addEventListener('input', debounce(searchDev,200));
  document.getElementById('ports').addEventListener('input', ev=>{
    if(ev.target.classList.contains('searchTarget')) searchTargetDebounced(ev.target);
  });
  document.getElementById('ports').addEventListener('change', ev=>{
    if(ev.target.classList.contains('searchTarget')) chooseTarget(ev.target);
  });
  document.getElementById('ports').addEventListener('click', disconnect);

  // 初始加载：空查询列出全部设备
  searchDev();
})();
</script>

<style>
ul.tree { list-style: none; padding-left: 1em; }
ul.tree > li { margin: .25em 0; }
ul.tree li ul { margin-top: .25em; padding-left: 1.2em; border-left: 2px solid #eee; }
ul.tree code { padding: 0 .25em; background:#f5f5f5; border-radius:4px; }
details { margin: .25em 0; }
</style>
{% endblock %}

