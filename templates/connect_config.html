{% extends "layout.html" %}
{% block title %}连接配置 · {{ project.name }}{% endblock %}
{% block content %}
<h2>连接配置 · 项目：{{ project.name }}</h2>

<!-- 常量 URL 与 PID -->
<script>
  const PID = Number('{{ project.id }}');
  const URL_SEARCH = "{{ url_for('connect_bp.api_search_devices', pid=project.id) }}";
  const URL_CAND   = "{{ url_for('connect_bp.api_candidates',    pid=project.id) }}";
  const URL_MAKE   = "{{ url_for('connect_bp.api_make_link',     pid=project.id) }}";
  const URL_LINKS  = "{{ url_for('connect_bp.api_list_links',    pid=project.id) }}";
  const URL_DEL    = (id) => "{{ url_for('connect_bp.api_delete_link', pid=project.id, link_id=0) }}".replace('/0/','/'+id+'/');
</script>

<div class="grid-2" style="gap:16px;">
  <section>
    <h3>设备 A</h3>
    <input id="qA" type="text" placeholder="按设备编号/型号搜索">
    <button class="btn" id="btnSearchA">搜索</button>
    <ul id="listA" class="tree"></ul>
  </section>

  <section>
    <h3>设备 B</h3>
    <input id="qB" type="text" placeholder="按设备编号/型号搜索">
    <button class="btn" id="btnSearchB">搜索</button>
    <ul id="listB" class="tree"></ul>
  </section>
</div>

<div style="margin-top:12px;">
  <button class="btn primary" id="btnLoad">加载候选端口</button>
  <span id="pairInfo" class="muted"></span>
</div>

<div class="grid-2" style="gap:16px; margin-top:12px;">
  <section>
    <h3>可选端口 · A</h3>
    <ul id="candA" class="tree"></ul>
  </section>
  <section>
    <h3>可选端口 · B</h3>
    <ul id="candB" class="tree"></ul>
  </section>
</div>

<div style="margin-top:12px;">
  <button class="btn primary" id="btnMake" disabled>建立连接</button>
  <span id="msg" class="muted"></span>
</div>

<h3 style="margin-top:16px;">已连接</h3>
<ul id="links" class="tree"></ul>

<script>
(() => {
  // 全局选择状态
  let selA = null, selB = null;      // 选择的设备
  let pickA = null, pickB = null;    // 选择的端口

  // 工具
  async function j(url){ const r = await fetch(url, {credentials:'same-origin'}); return await r.json(); }
  async function jp(url, data){
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: new URLSearchParams(data),
      credentials:'same-origin'
    });
    return await r.json();
  }
  const debounce = (fn, wait=200) => {
    let t=null; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  };

  // 搜索设备
  async function searchDev(side){
    try{
      const q = document.getElementById('q'+side).value || '';
      const res = await j(`${URL_SEARCH}?q=${encodeURIComponent(q)}`);
      const ul = document.getElementById('list'+side);
      ul.innerHTML = '';
      (res.data||[]).forEach(d=>{
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="radio" name="dev${side}" value="${d.id}">
            ${d.name} <span class="muted">(${d.model_code||''})</span></label>`;
        ul.appendChild(li);
      });
      // 重绑选择事件
      ul.onchange = ()=>{
        const v = ul.querySelector(`input[name="dev${side}"]:checked`)?.value;
        if (side==='A') { selA = v?Number(v):null; pickA=null; document.getElementById('candA').innerHTML=''; }
        else { selB = v?Number(v):null; pickB=null; document.getElementById('candB').innerHTML=''; }
        document.getElementById('pairInfo').textContent='';
        document.getElementById('btnMake').disabled = !(pickA && pickB);
      };
    }catch(e){
      alert('搜索失败：'+e);
    }
  }

  // 候选端口
  async function loadCandidates(){
    try{
      document.getElementById('candA').innerHTML='';
      document.getElementById('candB').innerHTML='';
      document.getElementById('pairInfo').textContent='';
      pickA = pickB = null;
      document.getElementById('btnMake').disabled = true;

      if(!selA || !selB){ alert('请先选择两台设备'); return; }
      if(selA === selB){ alert('不能选择同一台设备作为 A 和 B'); return; }

      const r = await j(`${URL_CAND}?a=${selA}&b=${selB}`);
      if(!r.ok){ alert(r.err||'加载失败'); return; }
      const L = r.data.left||[], R = r.data.right||[];
      renderCand('A', L); renderCand('B', R);
      document.getElementById('pairInfo').textContent = `候选：A ${L.length} 个；B ${R.length} 个`;
      await refreshLinks(); // 刷新已连接
    }catch(e){
      alert('加载候选失败：'+e);
    }
  }

  function renderCand(side, rows){
    const ul = document.getElementById('cand'+side); ul.innerHTML='';
    const grp = {};
    rows.forEach(x=>{
      const t = x.port_type_name || '未分类';
      const a = x.attr_name      || '（未命名属性）';
      (grp[t] = grp[t] || ({}));
      (grp[t][a] = grp[t][a] || []).push(x);
    });
    Object.keys(grp).forEach(t=>{
      const liT = document.createElement('li'); liT.innerHTML = `<strong>${t}</strong>`;
      const ulA = document.createElement('ul');
      Object.keys(grp[t]).forEach(a=>{
        const liA = document.createElement('li'); liA.innerHTML = `<span>${a}</span>`;
        const ulP = document.createElement('ul');
        grp[t][a].forEach(p=>{
          const disabled = !!p.occupied;
          const liP = document.createElement('li');
          liP.innerHTML = `<label style="${disabled?'color:#aaa;':''}">
             <input type="radio" name="port${side}" value="${p.port_id}" ${disabled?'disabled':''}>
             <code>${p.name}</code>${p.direction ? `<span class="muted"> / ${p.direction}</span>` : ''}
          </label>`;
          ulP.appendChild(liP);
        });
        liA.appendChild(ulP); ulA.appendChild(liA);
      });
      liT.appendChild(ulA); ul.appendChild(liT);
    });

    // 重绑选择事件
    ul.onchange = ()=>{
      const v = ul.querySelector(`input[name="port${side}"]:checked`)?.value;
      if (side==='A') pickA = v?Number(v):null;
      else            pickB = v?Number(v):null;
      document.getElementById('btnMake').disabled = !(pickA && pickB);
    };
  }

  async function makeLink(){
    try{
      if(!pickA || !pickB){ alert('请先在左右各选择一个端口'); return; }
      const r = await jp(URL_MAKE, {a_port_id: pickA, b_port_id: pickB});
      document.getElementById('msg').textContent = r.ok ? '已建立连接' : ('失败：'+(r.err||''));
      if(r.ok){
        pickA = pickB = null;
        document.getElementById('btnMake').disabled = true;
        await loadCandidates(); // 重新拉候选与已连接
      }
    }catch(e){
      alert('建立连接失败：'+e);
    }
  }

  async function refreshLinks(){
    try{
      const r = await j(URL_LINKS);
      const ul = document.getElementById('links'); ul.innerHTML='';
      (r.data||[]).forEach(L=>{
        const li = document.createElement('li');
        li.innerHTML = `
          #${L.id}
          <code>${L.a_device_name}</code>/<code>${L.a_port_name}</code>
          &nbsp;⇄&nbsp;
          <code>${L.b_device_name}</code>/<code>${L.b_port_name}</code>
          <span class="muted">[${L.status}]</span>
          <button class="btn danger" style="margin-left:8px" data-link-id="${L.id}">断开</button>
        `;
        ul.appendChild(li);
      });
      // 统一事件代理
      ul.onclick = async (ev)=>{
        const btn = ev.target.closest('button[data-link-id]');
        if(!btn) return;
        const id = btn.getAttribute('data-link-id');
        if(!confirm('确认断开该连接？')) return;
        try{
          const rr = await jp(URL_DEL(id), {});
          if(!rr.ok){ alert(rr.err||'删除失败'); return; }
          await loadCandidates();
        }catch(e){ alert('删除失败：'+e); }
      };
    }catch(e){
      alert('刷新连接列表失败：'+e);
    }
  }

  // 绑定事件（确保多次可触发）
  document.getElementById('btnSearchA').onclick = ()=>searchDev('A');
  document.getElementById('btnSearchB').onclick = ()=>searchDev('B');
  document.getElementById('qA').addEventListener('input', debounce(()=>searchDev('A'), 200));
  document.getElementById('qB').addEventListener('input', debounce(()=>searchDev('B'), 200));
  document.getElementById('btnLoad').onclick = loadCandidates;
  document.getElementById('btnMake').onclick = makeLink;

  // 暴露到全局（某些环境下需要）
  window._connectPage = { searchDev, loadCandidates, makeLink, refreshLinks };

  // 首次加载：空查询 => 全部设备；同时加载当前连接
  searchDev('A'); searchDev('B');
  refreshLinks();
})();
</script>

<style>
ul.tree { list-style: none; padding-left: 1em; }
ul.tree > li { margin: .25em 0; }
ul.tree li ul { margin-top: .25em; padding-left: 1.2em; border-left: 2px solid #eee; }
ul.tree code { padding: 0 .25em; background:#f5f5f5; border-radius:4px; }
.grid-2 { display:grid; grid-template-columns: 1fr 1fr; }
</style>
{% endblock %}
