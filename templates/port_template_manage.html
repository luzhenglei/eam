{% extends "layout.html" %}
{% block title %}模板端口规则管理 · #{{ template_id }}{% endblock %}
{% block content %}
<h2>模板端口规则管理 · 模板ID {{ template_id }}</h2>

<form method="post" style="margin:12px 0; padding:12px; border:1px solid #eee; border-radius:8px;">
  <!-- 5 列：标签 / 属性 / 端口类型 / 数量 / 最大连接数（全部必填） -->
  <div style="display:grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap:12px;">
    <div>
      <label>标签 <span style="color:#d33">*</span></label>
      <input type="text" name="code" placeholder="如 PW / GE / SFP" required>
    </div>
    <div>
      <label>属性 <span style="color:#d33">*</span></label>
      <input type="text" name="name" placeholder="例如：AC24V" required>
    </div>
    <div>
      <label>端口类型 <span style="color:#d33">*</span></label>
      <select name="port_type_id" required>
        <option value="" disabled selected>（请选择）</option>
        {% for t in port_types %}
          <option value="{{ t.id }}">{{ t.name }}{% if t.code %} ({{ t.code }}){% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>数量 <span style="color:#d33">*</span></label>
      <input type="number" name="qty" min="1" value="1" required>
    </div>
    <div>
      <label>最大连接数 <span style="color:#d33">*</span></label>
      <input type="number" name="max_links" min="1" value="1" required>
    </div>
  </div>
  <p class="muted" style="margin-top:6px;">
    生成规则：按“<code>标签 + 序号</code>”生成端口名；例如 标签=PW，数量=4 → 生成
    <code>PW1</code>、<code>PW2</code>、<code>PW3</code>、<code>PW4</code>。数量=1 时生成 <code>PW1</code>。
  </p>
  <div style="margin-top:8px;">
    <button class="btn primary" type="submit">新增规则</button>
    <a class="btn" href="{{ url_for('tpl_bp.templates_home') }}">返回模板列表</a>
  </div>
</form>

<table class="table">
  <thead>
    <tr>
      <th style="width:60px;">ID</th>
      <th>标签</th>
      <th>属性</th>
      <th>端口类型</th>
      <th>数量</th>
      <th>最大连接数</th>
      <th style="width:120px;">操作</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.code }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.port_type_name or '' }}</td>
        <td>{{ r.qty }}</td>
        <td>{{ r.max_links }}</td>
        <td>
          <form method="post" action="{{ url_for('tpl_bp.port_tpl_delete', pt_id=r.id) }}" onsubmit="return confirm('确认删除？')">
            <button class="btn danger" type="submit">删除</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not rows %}
      <tr><td colspan="7" class="muted">暂无规则</td></tr>
    {% endif %}
  </tbody>
</table>

<h3 style="margin-top:16px;">预览：本模板将生成的端口</h3>
<ul class="tree">
  {% for ptype, attrs in ports_tree.items() %}
    <li>
      <strong>{{ ptype }}</strong>
      <ul>
        {% for attr, names in attrs.items() %}
          <li>
            {{ attr }}
            <ul>
              {% for n in names %}
                <li>{{ n }}</li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ul>
    </li>
  {% endfor %}
  {% if not ports_tree %}
    <li class="muted">暂无可预览端口</li>
  {% endif %}
</ul>

<p class="muted">提示：进入设备“编辑属性”时会按上述规则增量补齐端口（不会删除已有端口）。</p>
{% endblock %}
